# üß† META-INSTRUCTIONS
- **Model Preference:** Use 'auto' (standard) model context. Be concise, thorough, and code-focused.
- **Timezone:** Current context is `Asia/Singapore`. Use `date-fns-tz` for date operations.

# üö¶ PHASE 1: THE PLAN ("Think First" Protocol)
**Trigger:** Before writing any code or when I ask for a feature.
**Action:** You MUST output a structured plan. Do not write code yet.

1. **The Context:** Briefly state the goal and "Why".
2. **File Strategy:** List files to create/modify.
3. **Test Strategy:**
   - *Rule:* Always add/update tests for logic changes.
   - *Rule:* If refactoring, ensure existing tests cover regressions.
4. **Docs Check:** (For later) Note if `USER_GUIDE.md` *will* need updates (but do not update it yet).

> **WAIT:** Stop here and wait for my "Go" or confirmation.

# üß™ PHASE 2: EXECUTION & LOCAL TDD
**Trigger:** After I approve the plan.
**Action:**

1. **Test First:** If new logic is needed, write the Unit Test file *first*.
2. **Implement:** Write the feature code.
3. **Verify:** ALWAYS output the terminal command to run the specific test (e.g., `npm test src/path/to/test.ts`).
   - *Constraint:* Do not assume success. Ask me to run it.

# üïµÔ∏è PHASE 3: STAGING DEPLOYMENT
**Trigger:** When I say "Push to Staging" or "Ship to Staging".
**Action:**

1. **Git Sequence:** Output this exact block:
   ```bash
   git add .
   git commit -m "feat: [Concise Description]"
   git push origin staging

```

2. **Verification Prompt:** Immediately output the Manual Verification Block:
> **üïµÔ∏è Staging Smoke Tests (Step-by-Step):**


> 1. [Exact Step 1: e.g., "Send 'edit /15 20' to bot"]
> 2. [Exact Step 2: e.g., "Check Dashboard for $20 update"]
> 3. [Exact Step 3: e.g., "Try invalid ID '/999' - expect error"]
> 
> 


> Please manually verify this on the Telegram Staging Bot: https://web.telegram.org/k/#-3370162727



# üöÄ PHASE 4: PRODUCTION RELEASE

**Trigger:** When I say "Deploy", "Ship it", "Push to Prod", "Deploy to Prod", or "Release".
**Action:**

**REQUIREMENT:** User MUST be on `production` branch. If not, STOP and alert: "You must be on the production branch to deploy."

1. **Docs Update (Conditional):**
* **IF** `USER_GUIDE.md` was modified during the feature work, output: `git add USER_GUIDE.md && git commit -m "docs: Update User Guide"`
* **IF NOT**, skip this step (do not create empty commits).

2. **Pre-Flight Checks:**
   - Run `git status --porcelain`. IF output exists (dirty working directory) ‚Üí **STOP IMMEDIATELY**. Alert: "üõë Working directory is not clean. Commit or stash changes before deploying."
   - Run `git diff production...origin/main`. IF output exists ‚Üí **WARN**: "‚ö†Ô∏è Main is ahead of Production. You should pull Main into Production first to avoid overwriting hotfixes. Continue anyway? (This requires manual confirmation)"

3. **Dry-Run Protocol (Optional):**
   - IF user requests dry-run OR this is first-time use: Print all git commands that would be executed WITHOUT running them. Format as a code block with comments explaining each step.

4. **The "Safety Dance" Sequence:**
   Execute these steps in order. IF any command fails (non-zero exit) ‚Üí **STOP IMMEDIATELY** and proceed to Error Protocol.

   **Step 1 (Sync):** `git pull origin production`
   - Ensures local production branch is up-to-date with remote.

   **Step 2 (Tag):** Prompt user: "What is the Semantic Version for this release? (e.g., v1.2.0)"
   - Wait for user input. Validate format (should start with 'v' followed by semantic version).
   - Store version as `[VERSION]` variable.

   **Step 3 (Merge):**
   ```bash
   git checkout main
   git pull origin main
   git merge production
   ```

   **Step 4 (Seal):** `git tag -a [VERSION] -m "Release [VERSION]"`
   - Create annotated tag with the version provided by user.

   **Step 5 (Ship):** `git push origin main --tags`
   - Push main branch AND tags to remote. Live server watches main branch.

   **Step 6 (Return):** `git checkout production`
   - Return user to production branch for continued work.

5. **Error Protocol:**
   - IF any command in Safety Dance sequence fails (non-zero exit): **STOP IMMEDIATELY**
   - DO NOT attempt to auto-fix merge conflicts
   - DO NOT force push
   - Print: "üõë MANUAL INTERVENTION REQUIRED. Deployment halted. Resolve issues manually and retry."

6. **Final Report (Success):**
   "üöÄ Production Deploy Complete. Version [VERSION] has been pushed to main. Render should now see the deployment. You have been returned to the production branch."

**CRITICAL RULES:**
- **NEVER** just `git push` from feature branch or `production` branch directly to main
- Live server strictly watches the `main` branch only
- **MUST** execute complete "Safety Dance" sequence with version tagging
- **MUST** check for main drift before merging
- **MUST** tag every production release with semantic version
- Stop on merge conflicts - alert user, no force push, no auto-fix

# üö´ STRICT GUIDELINES

* Never skip the "Phase 1: Plan" step. Even for small changes, think first.
* Never update `USER_GUIDE.md` in Staging. Only in Phase 4.
* Never use Regex for JSON parsing.
* Always include specific data/commands in the Staging Smoke Tests (e.g., don't say "Test edit", say "Type edit /15 50").
