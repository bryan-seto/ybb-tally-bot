generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  BigInt                @id @default(autoincrement())
  name                String
  role                UserRole
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  recurringExpenses   RecurringExpense[]
  systemLogs          SystemLog[]
  transactionsAsPayer Transaction[]         @relation("Payer")
  interactionLogs     UserInteractionLog[]

  @@map("users")
}

model Transaction {
  id                 BigInt    @id @default(autoincrement())
  amountSGD          Float
  currency           String    @default("SGD")
  category           String?
  description        String?
  payerId            BigInt
  date               DateTime  @default(now())
  isSettled          Boolean   @default(false)
  splitType          SplitType @default(FULL)
  bryanPercentage    Float?    @default(0.7)
  hweiYeenPercentage Float?    @default(0.3)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  payer              User      @relation("Payer", fields: [payerId], references: [id])

  @@map("transactions")
}

model RecurringExpense {
  id                BigInt    @id @default(autoincrement())
  description       String
  amountOriginal    Float
  payerId           BigInt
  dayOfMonth        Int
  isActive          Boolean   @default(true)
  lastProcessedDate DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  payer             User      @relation(fields: [payerId], references: [id])

  @@map("recurring_expenses")
}

model Settings {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt

  @@map("settings")
}

model SystemLog {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt?
  event     String
  metadata  Json?
  timestamp DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])

  @@map("system_logs")
}

model DailyStats {
  date                 DateTime @id @unique
  dau                  Int
  receiptsProcessed    Int      @default(0)
  totalSpend           Float    @default(0)
  avgLatencyMs         Int      @default(0)
  peakHour             Int?
  spendVelocity7DayAvg Float    @default(0)

  @@map("daily_stats")
}

model UserInteractionLog {
  id              BigInt   @id @default(autoincrement())
  userId          BigInt
  timestamp       DateTime @default(now())
  interactionType String  // MESSAGE, CALLBACK, PHOTO, COMMAND, ACTION
  eventType       String  // text_message, button_click, transaction_create, etc.
  content         String?  // Sanitized content
  metadata        Json?    // JSONB for flexibility
  status          String   // SUCCESS, FAILURE, PENDING
  errorMessage    String?
  chatId          BigInt?
  chatType        String?  // private, group, supergroup
  messageId       BigInt?
  user            User     @relation(fields: [userId], references: [id])

  @@index([userId, timestamp])
  @@index([interactionType, timestamp])
  @@index([eventType, timestamp])
  @@index([timestamp]) // For partitioning
  @@map("user_interaction_logs")
}

enum UserRole {
  Bryan
  HweiYeen
}

enum SplitType {
  FULL // 70/30 split (default)
  PARTIAL // Legacy, not used
  FIFTY_FIFTY // 50/50 split
  PAYER_ONLY // 100% paid by payer only
}
